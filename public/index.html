<!-- public/index.html -->
<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Terabox Downloader - Test Page</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;max-width:980px;margin:20px auto;padding:10px}
    input[type=text]{width:80%}
    button{padding:8px 12px;margin-left:6px}
    pre{background:#f5f5f5;padding:10px;border-radius:6px;overflow:auto}
    .log{height:200px;overflow:auto;background:#111;color:#0f0;padding:10px;border-radius:6px}
  </style>
</head>
<body>
  <h2>Terabox Downloader â€” Test</h2>
  <p>Masukkan link share (contoh: https://www.terabox.club/wap/share/filelist?surl=MaX...)</p>
  <input id="shareUrl" type="text" placeholder="Paste share URL..." />
  <button id="inspect">Inspect</button>
  <div id="meta"></div>

  <hr/>

  <h3>Manual proxy download</h3>
  <p>Jika kamu punya direct link file, masukkan di bawah untuk mulai download via proxy dan lihat live log.</p>
  <input id="fileUrl" type="text" placeholder="Direct file URL (http/https)" />
  <button id="startDownload">Download via Proxy</button>
  <p>Log ID: <span id="logId">-</span></p>
  <div class="log" id="logArea"></div>

  <script>
    async function postJSON(path, body){ 
      const r = await fetch(path, { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify(body) });
      return r.json();
    }

    document.getElementById('inspect').onclick = async () => {
      const u = document.getElementById('shareUrl').value.trim();
      if(!u) return alert('masukkan url');
      document.getElementById('meta').innerHTML = 'Loading...';
      try {
        const data = await postJSON('/api/metadata', { url: u });
        document.getElementById('meta').innerHTML = '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
      } catch (e) {
        document.getElementById('meta').innerText = 'Error: ' + e.message;
      }
    };

    let currentLogId = null;
    let pollInterval = null;

    document.getElementById('startDownload').onclick = async () => {
      const fileUrl = document.getElementById('fileUrl').value.trim();
      if(!fileUrl) return alert('masukkan direct file url');
      // create a log id
      const id = 'log-' + Math.random().toString(36).slice(2,9);
      currentLogId = id;
      document.getElementById('logId').innerText = id;
      document.getElementById('logArea').innerText = 'Log started...\n';

      // open download in new tab (so browser saves it)
      const proxyUrl = `/api/proxy?url=${encodeURIComponent(fileUrl)}&id=${encodeURIComponent(id)}`;
      window.open(proxyUrl, '_blank');

      // start polling logs every 1s
      if (pollInterval) clearInterval(pollInterval);
      pollInterval = setInterval(async () => {
        try {
          const r = await fetch('/api/logs?id=' + encodeURIComponent(id));
          const d = await r.json();
          const area = document.getElementById('logArea');
          area.innerText = d.logs.map(l => `[${l.ts}] ${l.msg}`).join('\n');
          area.scrollTop = area.scrollHeight;
        } catch (e) {
          console.error(e);
        }
      }, 1000);
    };
  </script>
</body>
</html>
